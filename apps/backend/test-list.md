# TDD テストリスト: Age of Hero キャラクターシート管理システム

**作成日**: 2025-09-10  
**目的**: TDDで実装すべきテストシナリオの網羅的なリスト  
**ルール**: 実装中に気づいたテストシナリオは随時このリストに追加する

## 📋 API エンドポイント テスト

### GET /api/game-data

- [x] **正常系**: ゲームデータ取得が成功すること
  - [x] ステータス200を返すこと
  - [x] application/jsonのContent-Typeを返すこと
  - [x] classes配列が含まれること
  - [x] skills配列が含まれること
  - [x] heroSkills配列が含まれること
  - [x] items配列が含まれること
- [x] **データ構造**: 各データが正しい構造を持つこと
  - [x] クラスデータが必須フィールドを持つこと
  - [x] スキルデータがcategoryを持つこと
  - [x] ヒーロースキルがmaxLevel/costを持つこと
  - [x] アイテムがpriceを持つこと
- [x] **CORS**: CORSヘッダーが適切に設定されていること

### POST /api/characters

- [x] **正常系**: キャラクター作成が成功すること
  - [x] ステータス201を返すこと
  - [x] 作成されたキャラクターのidとurlを返すこと
  - [x] UUIDが正しい形式であること
- [x] **バリデーション**: リクエストデータの検証
  - [x] nameが必須であること
  - [x] nameが1-50文字であること
  - [x] selectedClassesが2つであること
  - [x] skillAllocationsが数値であること
- [x] **パスワード**: オプションのパスワード設定
  - [x] パスワードありで作成できること
  - [x] パスワードなしで作成できること
- [x] **エラーハンドリング**:
  - [x] 不正なJSONで400を返すこと
  - [x] バリデーション失敗で400を返すこと

### GET /api/characters/{id}

- [x] **正常系**: キャラクター取得が成功すること
  - [x] ステータス200を返すこと
  - [x] 完全なキャラクター情報を返すこと
  - [x] セッション履歴が含まれること
- [x] **エラーハンドリング**:
  - [x] 存在しないIDで404を返すこと
  - [x] 不正なUUID形式で400を返すこと

### PUT /api/characters/{id}

- [ ] **正常系**: キャラクター更新が成功すること
  - [x] セッション情報を追加できること
  - [x] ステータス200を返すこと
  - [x] 更新されたキャラクター情報を返すこと
- [ ] **セッション追加**:
  - [x] 新しいセッション記録を追加できること
  - [x] セッション履歴が時系列順になること
- [ ] **パスワード認証**:
  - [ ] 保護されたキャラクターはパスワード必須であること
  - [ ] 間違ったパスワードで401を返すこと
- [ ] **エラーハンドリング**:
  - [ ] 存在しないIDで404を返すこと

## 🔧 データモデル・ビジネスロジック テスト

### キャラクター作成ロジック

- [ ] **能力値計算**: 選択したクラスから能力値が正しく計算されること
  - [ ] 2つのクラスの能力値が合算されること
  - [ ] 能力値ボーナス+1が適用されること
  - [ ] HP/SPが正しく計算されること
  - [ ] 行動値（反射×2+知力）が正しく計算されること
- [ ] **技能初期値**: 能力値から技能初期値が計算されること
  - [ ] 各技能の初期値が能力値×10%であること
  - [ ] 割り振りポイントが正しく加算されること
  - [ ] 合計値が正しく計算されること
- [ ] **ヒーロースキル**: ヒーロースキルの制約チェック
  - [ ] 各スキルの最大レベルを超えないこと
- [ ] **特殊技**: 特殊技の制約チェック
  - [ ] レベルが1以上であること

### セッション管理ロジック

- [ ] **セッション追加**: セッション履歴への追加
  - [ ] セッションIDが自動生成されること
  - [ ] 作成日時が自動設定されること
  - [ ] セッション履歴が配列に追加されること
- [ ] **最新ステータス取得**: 最新セッションからステータス取得
  - [ ] セッション履歴がない場合は初期値を返すこと
  - [ ] 最新セッションのHP/SP/FCを返すこと
- [ ] **セッション編集**: 既存セッション情報の更新
  - [ ] セッションIDで特定のセッションを更新できること
  - [ ] 存在しないセッションIDでエラーになること

### データベース操作

- [ ] **接続**: データベース接続が正常に動作すること
  - [ ] 接続テストが成功すること
  - [ ] 接続エラー時の処理
- [ ] **CRUD操作**: 基本的なデータ操作
  - [ ] キャラクター作成（INSERT）
  - [ ] キャラクター取得（SELECT）
  - [ ] キャラクター更新（UPDATE）
  - [ ] トランザクション処理
- [ ] **JSON操作**: PostgreSQLのJSONB操作
  - [ ] JSON内の部分更新
  - [ ] セッション配列への要素追加
  - [ ] 複雑なJSON構造の検索

## 🛡️ セキュリティ・バリデーション テスト

### 認証・認可

- [ ] **パスワードハッシュ**: bcryptによるパスワード処理
  - [ ] パスワードがハッシュ化されて保存されること
  - [ ] 平文パスワードが保存されないこと
  - [ ] パスワード検証が正しく動作すること
- [ ] **アクセス制御**: URLベースアクセス制御
  - [ ] UUIDの推測困難性
  - [ ] パスワード保護の有効性

### 入力値バリデーション

- [ ] **SQLインジェクション対策**: Drizzle ORM使用による対策
- [ ] **XSS対策**: JSON応答のサニタイズ

## 🚀 パフォーマンス テスト

### レスポンス時間

- [ ] **キャラクター作成**: 2秒以内
- [ ] **キャラクター取得**: 500ms以内
- [ ] **ゲームデータ取得**: 200ms以内
- [ ] **セッション追加**: 1秒以内

### データベース効率

- [ ] **大量データ**: 100キャラクター環境での性能
- [ ] **複雑クエリ**: JSON検索の効率性
- [ ] **同時接続**: 10ユーザー同時アクセス

## 🔄 統合・E2E テスト

### エンドツーエンドシナリオ

- [ ] **キャラクター作成フロー**: 作成→取得→更新の一連の流れ
- [ ] **パスワード保護フロー**: 設定→認証→変更→削除の流れ
- [ ] **セッション管理フロー**: 記録→履歴確認→編集の流れ

### エラー復旧

- [ ] **DB接続失敗**: データベース切断時の処理
- [ ] **不正データ**: 破損したJSONデータの処理
- [ ] **部分失敗**: トランザクション失敗時のロールバック

---

## 📝 実装メモ

**実装順序の方針**:

1. ✅ まず最もシンプルなGET /api/game-dataから開始 - **完了**
2. ✅ 次にPOST /api/characters（新規作成）- **完了**
3. ✅ GET /api/characters/{id}（取得）- **完了**
4. 🔄 PUT系（更新）は最後 - **次のステップ**

**実装済み機能**:
- ✅ Zodバリデーションスキーマ（comprehensive validation in packages/schemas）
- ✅ Honoのzod validator middleware統合
- ✅ JSON parsing errorの適切な400エラーハンドリング 
- ✅ UUID形式のバリデーション（Zod使用）
- ✅ sessions配列のサポート（寛容なバリデーション）
- ✅ 完全なキャラクター情報の返却（sessions含む）

**技術的な決定**:
- data-model.mdに合わせてUUID制約を削除、実際のTRPGデータ（クラス名、スキル名）を使用
- エラーハンドリングミドルウェアでJSON parsing errorを適切に処理
- sessionsフィールドは全てoptionalで柔軟に対応

**次のステップ**: PUT /api/characters/{id} の実装

**気づいた追加テスト**:
（実装中に発見したテストシナリオを随時追加）

**完了したテスト**:
（チェックボックスにチェックを入れて進捗管理）
