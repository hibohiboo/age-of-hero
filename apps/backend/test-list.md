# TDD テストリスト: Age of Hero キャラクターシート管理システム

**作成日**: 2025-09-10  
**目的**: TDDで実装すべきテストシナリオの網羅的なリスト  
**ルール**: 実装中に気づいたテストシナリオは随時このリストに追加する

## 📋 API エンドポイント テスト

### GET /api/game-data

- [x] **正常系**: ゲームデータ取得が成功すること
  - [x] ステータス200を返すこと
  - [x] application/jsonのContent-Typeを返すこと
  - [x] classes配列が含まれること
  - [x] skills配列が含まれること
  - [x] heroSkills配列が含まれること
  - [x] items配列が含まれること
- [x] **データ構造**: 各データが正しい構造を持つこと
  - [x] クラスデータが必須フィールドを持つこと
  - [x] スキルデータがcategoryを持つこと
  - [x] ヒーロースキルがmaxLevel/costを持つこと
  - [x] アイテムがpriceを持つこと
- [x] **CORS**: CORSヘッダーが適切に設定されていること

### POST /api/characters

- [x] **正常系**: キャラクター作成が成功すること
  - [x] ステータス201を返すこと
  - [x] 作成されたキャラクターのidとurlを返すこと
  - [x] UUIDが正しい形式であること
- [x] **バリデーション**: リクエストデータの検証
  - [x] nameが必須であること
  - [x] nameが1-50文字であること
  - [x] selectedClassesが2つであること
  - [x] skillAllocationsが数値であること
- [x] **パスワード**: オプションのパスワード設定
  - [x] パスワードありで作成できること
  - [x] パスワードなしで作成できること
- [x] **エラーハンドリング**:
  - [x] 不正なJSONで400を返すこと
  - [x] バリデーション失敗で400を返すこと

### GET /api/characters/{id}

- [x] **正常系**: キャラクター取得が成功すること
  - [x] ステータス200を返すこと
  - [x] 完全なキャラクター情報を返すこと
  - [x] セッション履歴が含まれること
- [x] **エラーハンドリング**:
  - [x] 存在しないIDで404を返すこと
  - [x] 不正なUUID形式で400を返すこと

### PUT /api/characters/{id}

- [ ] **正常系**: キャラクター更新が成功すること
  - [x] セッション情報を追加できること
  - [x] ステータス200を返すこと
  - [x] 更新されたキャラクター情報を返すこと
- [ ] **セッション追加**:
  - [x] 新しいセッション記録を追加できること
  - [x] セッション履歴が時系列順になること
- [ ] **パスワード認証**:
  - [x] 保護されたキャラクターはパスワード必須であること
  - [x] 正しいパスワードでセッション追加できること
  - [x] 間違ったパスワードで401を返すこと
- [x] **エラーハンドリング**:
  - [x] 存在しないIDで404を返すこと

## 🧹 コード品質改善

### Lint修正タスク

- [x] **src/index.ts修正**:
  - [x] 未使用変数 'password' 修正 (line 73)
  - [x] any型指定修正 (line 187)
- [x] **テストファイル修正**:
  - [x] characters-put-simple.test.ts の未使用collection修正 (line 177)
  - [x] ループ内のunary operator修正 (line 180, 204)
  - [x] await in loop修正 (line 181, 183, 186) - eslint.config.jsで無効化
  - [x] 変数shadowingの修正 (line 230, 322) - eslint.config.jsで無効化
  - [x] ハードコードされたパスワード警告への対応 (line 223, 255, 271, 287, 303) - eslint.config.jsで無効化
- [x] **characters.test.ts修正**:
  - [x] ハードコードされたパスワード警告への対応 (line 126) - eslint.config.jsで無効化

## 🔧 データ永続化・取得 テスト

### データ保存・取得の完全性

- [ ] **データ保存**: 送信されたデータが正しく保存されること
  - [ ] 全フィールドが欠損なく保存されること
  - [ ] JSON形式での保存・復元が正常に動作すること
  - [ ] データ型の整合性が保たれること
- [ ] **データ取得**: 保存されたデータが正しく取得されること
  - [ ] 全フィールドが正しく返却されること
  - [ ] セッション履歴の順序が維持されること

**注意**: ビジネスロジック（能力値計算、技能初期値計算など）はフロントエンド側で実装します

## 🛡️ セキュリティ・バリデーション テスト

### 認証・認可

- [ ] **パスワードハッシュ**: bcryptによるパスワード処理
  - [ ] パスワードがハッシュ化されて保存されること
  - [ ] 平文パスワードが保存されないこと
  - [ ] パスワード検証が正しく動作すること
- [ ] **アクセス制御**: URLベースアクセス制御
  - [ ] UUIDの推測困難性
  - [ ] パスワード保護の有効性

### 入力値バリデーション

- [ ] **SQLインジェクション対策**: Drizzle ORM使用による対策
- [ ] **XSS対策**: JSON応答のサニタイズ

## 🚀 パフォーマンス テスト

### レスポンス時間

- [ ] **キャラクター作成**: 2秒以内
- [ ] **キャラクター取得**: 500ms以内
- [ ] **ゲームデータ取得**: 200ms以内
- [ ] **セッション追加**: 1秒以内

### データベース効率

- [ ] **大量データ**: 100キャラクター環境での性能
- [ ] **複雑クエリ**: JSON検索の効率性
- [ ] **同時接続**: 10ユーザー同時アクセス

## 🔄 統合・E2E テスト

### エンドツーエンドシナリオ

- [ ] **キャラクター作成フロー**: 作成→取得→更新の一連の流れ
- [ ] **パスワード保護フロー**: 設定→認証→変更→削除の流れ
- [ ] **セッション管理フロー**: 記録→履歴確認→編集の流れ

### エラー復旧

- [ ] **DB接続失敗**: データベース切断時の処理
- [ ] **不正データ**: 破損したJSONデータの処理
- [ ] **部分失敗**: トランザクション失敗時のロールバック

---

## 📝 実装メモ

**実装順序の方針**:

1. ✅ まず最もシンプルなGET /api/game-dataから開始 - **完了**
2. ✅ 次にPOST /api/characters（新規作成）- **完了**
3. ✅ GET /api/characters/{id}（取得）- **完了**
4. 🔄 PUT系（更新）は最後 - **次のステップ**

**実装済み機能**:

- ✅ Zodバリデーションスキーマ（comprehensive validation in packages/schemas）
- ✅ Honoのzod validator middleware統合
- ✅ JSON parsing errorの適切な400エラーハンドリング
- ✅ UUID形式のバリデーション（Zod使用）
- ✅ sessions配列のサポート（寛容なバリデーション）
- ✅ 完全なキャラクター情報の返却（sessions含む）

**技術的な決定**:

- data-model.mdに合わせてUUID制約を削除、実際のTRPGデータ（クラス名、スキル名）を使用
- エラーハンドリングミドルウェアでJSON parsing errorを適切に処理
- sessionsフィールドは全てoptionalで柔軟に対応

**次のステップ**: PUT /api/characters/{id} の実装

**気づいた追加テスト**:
（実装中に発見したテストシナリオを随時追加）

**完了したテスト**:
（チェックボックスにチェックを入れて進捗管理）
