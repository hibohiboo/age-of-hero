openapi: 3.0.3
info:
  title: Age of Hero キャラクターシート API
  description: Age of Hero TRPG キャラクターシート管理システムのREST API
  version: 0.1.0
  contact:
    name: Age of Hero システム
servers:
  - url: https://api.age-of-hero.example.com
    description: プロダクション環境
  - url: http://localhost:3000
    description: ローカル開発環境

paths:
  /api/game-data:
    get:
      summary: ゲームデータ取得
      description: クラス、スキル、アイテム等のマスターデータを取得
      tags:
        - GameData
      responses:
        '200':
          description: ゲームデータ取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameDataResponse'

  /api/characters:
    get:
      summary: キャラクター一覧取得
      description: 作成されたキャラクターの一覧を取得（更新日時の降順）
      tags:
        - Character
      responses:
        '200':
          description: キャラクター一覧取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterListResponse'

    post:
      summary: キャラクター作成
      description: 新しいキャラクターを作成し、一意のIDを発行
      tags:
        - Character
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCharacterRequest'
      responses:
        '201':
          description: キャラクター作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateCharacterResponse'
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/characters/{id}:
    get:
      summary: キャラクター取得
      description: キャラクターIDを使用してキャラクター情報を取得
      tags:
        - Character
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: password
          in: query
          description: パスワード保護されている場合のパスワード
          required: false
          schema:
            type: string
      responses:
        '200':
          description: キャラクター取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterResponse'
        '400':
          description: 不正なUUID形式
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: パスワード認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: キャラクターが見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      summary: キャラクター更新
      description: キャラクター情報の全体更新またはセッション情報の追加
      tags:
        - Character
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCharacterRequest'
      responses:
        '200':
          description: キャラクター更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterResponse'
        '400':
          description: バリデーションエラー（不正なUUID形式含む）
        '401':
          description: パスワード認証エラー
        '404':
          description: キャラクターが見つからない

components:
  schemas:
    GameDataResponse:
      type: object
      properties:
        classes:
          type: array
          items:
            $ref: '#/components/schemas/ClassData'
        skills:
          type: array
          items:
            $ref: '#/components/schemas/SkillData'
        heroSkills:
          type: array
          items:
            $ref: '#/components/schemas/HeroSkillData'
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemData'

    ClassData:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: 'マッスル'
        physicalBase:
          type: integer
          minimum: 0
        reflexBase:
          type: integer
          minimum: 0
        sensoryBase:
          type: integer
          minimum: 0
        intellectualBase:
          type: integer
          minimum: 0
        supernaturalBase:
          type: integer
          minimum: 0
        hpBase:
          type: integer
          minimum: 1
        spBase:
          type: integer
          minimum: 1
        description:
          type: string

    SkillData:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: 'パワー'
        category:
          type: string
          enum: ['physical', 'reflex', 'sensory', 'intellectual']
        description:
          type: string
        order:
          type: integer

    HeroSkillData:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: '《パワードライブ》'
        maxLevel:
          type: integer
          minimum: 1
        timing:
          type: string
          example: 'メジャーアクション'
        skill:
          type: string
          example: '白兵攻撃'
        target:
          type: string
          example: '単体'
        range:
          type: string
          example: '武器'
        cost:
          type: string
          example: "SP3"
          description: "コスト (文字列: SP3, 2/ターン等)"
        effect:
          type: string
        classRestriction:
          type: array
          items:
            type: string
          nullable: true

    ItemData:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: '射撃武器Ａ'
        type:
          type: string
          enum: ['白兵', '射撃', '白兵/射撃', '防具', '消耗品', 'その他']
          example: '射撃'
        skill:
          type: string
          nullable: true
          example: '〈射撃〉'
          description: '武器の対応技能'
        modifier:
          type: string
          nullable: true
          example: '＋０％'
          description: '武器の修正値'
        attackPower:
          type: string
          nullable: true
          example: '＋５'
          description: '武器の攻撃力'
        guardValue:
          type: string
          nullable: true
          example: '０'
          description: '武器のガード値'
        range:
          type: string
          nullable: true
          example: '近'
          description: '武器の射程 (至近/近/中/遠)'
        dodge:
          type: string
          nullable: true
          example: '＋０％'
          description: '防具のドッジ修正'
        actionValue:
          type: string
          nullable: true
          example: '＋０'
          description: '防具の行動値修正'
        protection:
          type: string
          nullable: true
          example: '５'
          description: '防具の防護点'
        price:
          type: integer
          minimum: 0
          example: 6
          description: '価格 (0=常備化不可または価格なし)'
        effect:
          type: string
          nullable: true
          example: 'マイナーアクション、メジャーアクションで使用可能。ＨＰを２Ｄ点回復する。'
          description: 'アイテムの効果説明'
        quantity:
          type: integer
          nullable: true
          minimum: 1
          description: '消耗品の数量'

    CreateCharacterRequest:
      type: object
      required:
        - name
        - selectedClasses
        - abilityBonus
        - skillPointsLimit
        - heroSkillLevelLimit
        - itemPriceLimit
        - skillAllocations
        - heroSkills
        - specialAttacks
        - items
        - status
        - statusModifiers
        - sessions
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
          example: '山田太郎'
        selectedClasses:
          type: array
          items:
            type: string
          minItems: 2
          maxItems: 2
          description: '選択した2つのクラス名 (重複可)'
        abilityBonus:
          type: string
          enum:
            ['physical', 'reflex', 'sensory', 'intellectual', 'supernatural']
          description: '能力値+1ボーナスの適用先'
        skillPointsLimit:
          type: integer
          minimum: 1
          example: 150
          description: '技能ポイント上限(%)'
        heroSkillLevelLimit:
          type: integer
          minimum: 1
          example: 7
          description: 'ヒーロースキルレベル上限'
        itemPriceLimit:
          type: integer
          minimum: 1
          example: 20
          description: 'アイテム価格上限(点)'
        skillAllocations:
          type: object
          additionalProperties:
            type: integer
          description: '技能名 → 割り振りポイントのマップ'
        heroSkills:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: 'パワードライブ'
              level:
                type: integer
                minimum: 1
              maxLevel:
                type: integer
                minimum: 1
              timing:
                type: string
                example: 'メジャーアクション'
              skill:
                type: string
                example: '白兵攻撃'
              target:
                type: string
                example: '単体'
              range:
                type: string
                example: '武器'
              cost:
                type: string
                example: "SP3"
              effect:
                type: string
        specialAttacks:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: '能力暴走'
              level:
                type: integer
                minimum: 1
              maxLevel:
                type: integer
                minimum: 1
              timing:
                type: string
                example: 'スタートプロセス'
              skill:
                type: string
                example: 'なし'
              target:
                type: string
                example: '自身'
              range:
                type: string
                example: 'なし'
              cost:
                type: string
                example: "SP3"
              effect:
                type: string
        items:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: "射撃武器Ａ"
              type:
                type: string
                enum: ['白兵', '射撃', '白兵/射撃', '防具', '消耗品', 'その他']
              skill:
                type: string
                nullable: true
                example: "〈射撃〉"
              modifier:
                type: string
                nullable: true
                example: "＋０％"
              attackPower:
                type: string
                nullable: true
                example: "＋５"
              guardValue:
                type: string
                nullable: true
                example: "０"
              range:
                type: string
                nullable: true
                example: "近"
              dodge:
                type: string
                nullable: true
                example: "＋０％"
              actionValue:
                type: string
                nullable: true
                example: "＋０"
              protection:
                type: string
                nullable: true
                example: "５"
              price:
                type: integer
                minimum: 0
              effect:
                type: string
                nullable: true
              quantity:
                type: integer
                nullable: true
                minimum: 1
        status:
          type: object
          properties:
            hp:
              type: integer
              minimum: 1
              description: "最大HP（計算済み最終値）"
            sp:
              type: integer
              minimum: 1
              description: "最大SP（計算済み最終値）"
            actionValue:
              type: integer
              minimum: 1
              description: "行動値（計算済み最終値）"
          required:
            - hp
            - sp
            - actionValue
        statusModifiers:
          type: object
          properties:
            hpModifier:
              type: integer
              example: 0
              description: "HP補正値（±）"
            spModifier:
              type: integer
              example: 0
              description: "SP補正値（±）"
            actionValueModifier:
              type: integer
              example: 0
              description: "行動値補正値（±）"
          required:
            - hpModifier
            - spModifier
            - actionValueModifier
        sessions:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              sessionName:
                type: string
                example: "第1話 英雄の始まり"
              gmName:
                type: string
                example: "田中GM"
              sessionDate:
                type: string
                format: date
                example: "2024-01-15"
              currentHp:
                type: integer
                minimum: 0
                example: 25
              currentSp:
                type: integer
                minimum: 0
                example: 15
              currentFc:
                type: integer
                minimum: 0
                nullable: true
                example: 3
              experiencePoints:
                type: integer
                minimum: 0
                example: 10
              memo:
                type: string
                nullable: true
                example: "初回セッション。ボス戦で重傷を負った。"
              createdAt:
                type: string
                format: date-time
        password:
          type: string
          nullable: true
          description: 'オプションのパスワード'

    CreateCharacterResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          example: '/character/123e4567-e89b-12d3-a456-426614174000'

    CharacterListResponse:
      type: array
      items:
        type: object
        properties:
          id:
            type: string
            format: uuid
          name:
            type: string
            example: '山田太郎'
          createdAt:
            type: string
            format: date-time
          updatedAt:
            type: string
            format: date-time

    CharacterResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        physicalAbility:
          type: integer
        reflexAbility:
          type: integer
        sensoryAbility:
          type: integer
        intellectualAbility:
          type: integer
        supernaturalAbility:
          type: integer
        hp:
          type: integer
          description: "最大HP（計算済み最終値）"
        sp:
          type: integer
          description: "最大SP（計算済み最終値）"
        actionValue:
          type: integer
          description: "行動値（計算済み最終値）"
        statusModifiers:
          type: object
          properties:
            hpModifier:
              type: integer
              example: 0
              description: "HP補正値（±）"
            spModifier:
              type: integer
              example: 0
              description: "SP補正値（±）"
            actionValueModifier:
              type: integer
              example: 0
              description: "行動値補正値（±）"
        sessions:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              sessionName:
                type: string
              gmName:
                type: string
              sessionDate:
                type: string
                format: date
              currentHp:
                type: integer
                minimum: 0
              currentSp:
                type: integer
                minimum: 0
              currentFc:
                type: integer
                minimum: 0
                nullable: true
              experiencePoints:
                type: integer
                minimum: 0
              memo:
                type: string
                nullable: true
              createdAt:
                type: string
                format: date-time
        classes:
          type: array
          items:
            $ref: '#/components/schemas/ClassData'
        skills:
          type: array
          items:
            type: object
            properties:
              skill:
                $ref: '#/components/schemas/SkillData'
              baseValue:
                type: integer
              allocatedPoints:
                type: integer
              totalValue:
                type: integer
        heroSkills:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: 'パワードライブ'
              level:
                type: integer
                minimum: 1
              maxLevel:
                type: integer
                minimum: 1
              timing:
                type: string
                example: 'メジャーアクション'
              skill:
                type: string
                example: '白兵攻撃'
              target:
                type: string
                example: '単体'
              range:
                type: string
                example: '武器'
              cost:
                type: string
                example: "SP3"
              effect:
                type: string
        specialAttacks:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: '能力暴走'
              level:
                type: integer
                minimum: 1
              maxLevel:
                type: integer
                minimum: 1
              timing:
                type: string
                example: 'スタートプロセス'
              skill:
                type: string
                example: 'なし'
              target:
                type: string
                example: '自身'
              range:
                type: string
                example: 'なし'
              cost:
                type: string
                example: "SP3"
              effect:
                type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemData'
        isPasswordProtected:
          type: boolean

    UpdateCharacterRequest:
      type: object
      description: キャラクター全体更新またはセッション追加のリクエスト
      properties:
        # キャラクター全体更新用プロパティ (sessionが未定義の場合)
        name:
          type: string
          minLength: 1
          maxLength: 50
          description: キャラクター名
        selectedClasses:
          type: array
          items:
            type: string
          minItems: 2
          maxItems: 2
          description: 選択した2つのクラス名
        abilityBonus:
          type: string
          enum: ['physical', 'reflex', 'sensory', 'intellectual', 'supernatural']
          description: 能力値+1ボーナスの適用先
        skillPointsLimit:
          type: integer
          minimum: 1
          description: 技能ポイント上限(%)
        heroSkillLevelLimit:
          type: integer
          minimum: 1
          description: ヒーロースキルレベル上限
        itemPriceLimit:
          type: integer
          minimum: 1
          description: アイテム価格上限(点)
        skillAllocations:
          type: object
          additionalProperties:
            type: integer
          description: 技能名 → 割り振りポイントのマップ
        heroSkills:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              level:
                type: integer
                minimum: 1
              maxLevel:
                type: integer
                minimum: 1
              timing:
                type: string
              skill:
                type: string
              target:
                type: string
              range:
                type: string
              cost:
                type: string
              effect:
                type: string
        specialAttacks:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              level:
                type: integer
                minimum: 1
              maxLevel:
                type: integer
                minimum: 1
              timing:
                type: string
              skill:
                type: string
              target:
                type: string
              range:
                type: string
              cost:
                type: string
              effect:
                type: string
        items:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
                enum: ['白兵', '射撃', '白兵/射撃', '防具', '消耗品', 'その他']
              skill:
                type: string
                nullable: true
              modifier:
                type: string
                nullable: true
              attackPower:
                type: string
                nullable: true
              guardValue:
                type: string
                nullable: true
              range:
                type: string
                nullable: true
              dodge:
                type: string
                nullable: true
              actionValue:
                type: string
                nullable: true
              protection:
                type: string
                nullable: true
              price:
                type: integer
                minimum: 0
              effect:
                type: string
                nullable: true
              quantity:
                type: integer
                nullable: true
                minimum: 1
        status:
          type: object
          properties:
            hp:
              type: integer
              minimum: 1
            sp:
              type: integer
              minimum: 1
            actionValue:
              type: integer
              minimum: 1
        statusModifiers:
          type: object
          properties:
            hpModifier:
              type: integer
            spModifier:
              type: integer
            actionValueModifier:
              type: integer
        # セッション追加用プロパティ (sessionが定義されている場合)
        session:
          type: object
          properties:
            id:
              type: string
              format: uuid
            sessionName:
              type: string
            gmName:
              type: string
            sessionDate:
              type: string
              format: date
            currentHp:
              type: integer
              minimum: 0
            currentSp:
              type: integer
              minimum: 0
            currentFc:
              type: integer
              minimum: 0
              nullable: true
            experiencePoints:
              type: integer
              minimum: 0
            memo:
              type: string
              nullable: true
        password:
          type: string
          nullable: true
          description: 'パスワード保護されている場合のパスワード'

    SetPasswordRequest:
      type: object
      properties:
        currentPassword:
          type: string
          nullable: true
          description: '現在のパスワード (変更時のみ)'
        newPassword:
          type: string
          nullable: true
          description: '新しいパスワード (nullで保護解除)'

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: 'VALIDATION_ERROR'
            message:
              type: string
              example: 'バリデーションエラーが発生しました'
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string
